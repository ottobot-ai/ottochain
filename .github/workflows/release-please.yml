name: Release Please

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          # Use PAT to allow triggering other workflows (release.yml, docker.yml)
          # GITHUB_TOKEN cannot trigger other workflows due to GitHub security
          token: ${{ secrets.RELEASE_TOKEN }}
          # Use config file for settings
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # When release is created, notify deploy repo
  notify-deploy:
    name: Notify Deploy Repo
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deploy version bump
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_REPO_TOKEN }}
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          
          if [ -z "$DEPLOY_TOKEN" ]; then
            echo "âš ï¸ DEPLOY_REPO_TOKEN not set, skipping deploy notification"
            exit 0
          fi
          
          echo "ðŸ“¦ Notifying deploy repo of ottochain v$VERSION"
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $DEPLOY_TOKEN" \
            https://api.github.com/repos/ottobot-ai/ottochain-deploy/dispatches \
            -d "{\"event_type\":\"version-bump\",\"client_payload\":{\"component\":\"ottochain\",\"version\":\"$VERSION\"}}"
          
          echo "âœ… Dispatched version-bump event to ottochain-deploy"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Triggered Workflows" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… release.yml (JAR build + GitHub Release)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… docker.yml (Container image)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deploy repo notified" >> $GITHUB_STEP_SUMMARY
