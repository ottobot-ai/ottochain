name: E2E Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

env:
  TESSELLATION_VERSION: "4.0.0-rc.2"

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'sbt'

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Clone tessellation
        run: |
          git clone --depth 1 --branch "v${TESSELLATION_VERSION}" \
            https://github.com/Constellation-Labs/tessellation.git tessellation

      - name: Apply tessellation patches
        working-directory: tessellation
        run: |
          git apply ../e2e-test/patches/v4.0.0-rc.2-compile-fix.patch
          git apply ../e2e-test/patches/v4.0.0-rc.2-java21-deps.patch

      - name: Start cluster
        working-directory: tessellation
        run: |
          export TESSELLATION_VERSION="${TESSELLATION_VERSION}"
          just up --metagraph="${GITHUB_WORKSPACE}" --dl1 --data

      - name: Wait for cluster health
        run: |
          # Tessellation auto-join handles validator joining via CL_DOCKER_JOIN=true
          # DL1 validators have initial delays: node 1 = 42s, node 2 = 54s
          # Plus 10 retries * 10s delay = up to 154s for full join
          # We wait up to 4 minutes (240s) for all nodes to be Ready
          
          wait_for_node() {
            local name=$1 port=$2 max_wait=${3:-120}
            local iterations=$((max_wait / 2))
            for i in $(seq 1 $iterations); do
              if curl -sf "http://localhost:${port}/node/info" 2>/dev/null | grep -q '"state":"Ready"'; then
                echo "  âœ“ $name (port $port): Ready"
                return 0
              fi
              sleep 2
            done
            echo "  âœ— $name (port $port): TIMEOUT after ${max_wait}s" && return 1
          }
          
          echo "Waiting for genesis nodes (120s timeout)..."
          wait_for_node "GL0" 9000 120
          wait_for_node "ML0" 9200 120
          wait_for_node "DL1-0" 9400 120
          
          echo ""
          echo "Waiting for DL1 validators (240s timeout - they have join delays)..."
          wait_for_node "DL1-1" 9410 240
          wait_for_node "DL1-2" 9420 240
          
      - name: Verify DL1 cluster size
        run: |
          echo "Verifying DL1 cluster formation..."
          CLUSTER_SIZE=$(curl -s http://localhost:9400/cluster/info | jq 'length' 2>/dev/null || echo "0")
          echo "DL1 cluster size: $CLUSTER_SIZE"
          
          if [ "$CLUSTER_SIZE" -lt 3 ]; then
            echo "::error::DL1 cluster size is $CLUSTER_SIZE (expected 3)"
            echo ""
            echo "Cluster info:"
            curl -s http://localhost:9400/cluster/info | jq . || true
            echo ""
            echo "DL1-1 state: $(curl -s http://localhost:9410/node/state 2>/dev/null || echo 'unreachable')"
            echo "DL1-2 state: $(curl -s http://localhost:9420/node/state 2>/dev/null || echo 'unreachable')"
            exit 1
          fi
          
          echo "âœ“ DL1 cluster has $CLUSTER_SIZE peers"

      - name: Verify ML0 ordinal progression
        run: |
          echo "Checking ML0 ordinal progression..."
          # Wait a bit for consensus to warm up after node startup
          sleep 10
          ORD1=$(curl -sf http://localhost:9200/snapshots/latest 2>/dev/null | jq -r '.value.ordinal // .ordinal // empty' || echo "")
          if [ -z "$ORD1" ]; then
            echo "::warning::Could not fetch initial ML0 ordinal â€” skipping progression check"
          else
            echo "  Initial ordinal: $ORD1"
            sleep 30
            ORD2=$(curl -sf http://localhost:9200/snapshots/latest 2>/dev/null | jq -r '.value.ordinal // .ordinal // empty' || echo "")
            echo "  After 30s: $ORD2"
            if [ "$ORD1" = "$ORD2" ]; then
              echo "::warning::Ordinals haven't advanced ($ORD1), retrying after 30s grace period..."
              sleep 30
              ORD3=$(curl -sf http://localhost:9200/snapshots/latest 2>/dev/null | jq -r '.value.ordinal // .ordinal // empty' || echo "")
              echo "  After 60s total: $ORD3"
              if [ "$ORD1" = "$ORD3" ]; then
                echo "::error::ML0 consensus stalled â€” ordinal stuck at $ORD1 for 60 seconds"
                echo "## âš ï¸ ML0 Consensus Stall Detected" >> $GITHUB_STEP_SUMMARY
                echo "Ordinal stuck at \`$ORD1\` for 60 seconds after warmup." >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### Cluster Info" >> $GITHUB_STEP_SUMMARY
                curl -sf http://localhost:9200/cluster/info 2>/dev/null | jq . >> $GITHUB_STEP_SUMMARY || true
                exit 1
              fi
              echo "  âœ“ Ordinals advancing after grace period ($ORD1 â†’ $ORD3)"
            else
              echo "  âœ“ Ordinals advancing ($ORD1 â†’ $ORD2)"
            fi
          fi

      - name: Install E2E dependencies
        working-directory: e2e-test
        run: npm ci

      - name: Pre-flight canary transaction
        working-directory: e2e-test
        continue-on-error: true
        run: npx tsx scripts/canary-check.ts --maxRetries 30 --retryDelay 5

      - name: Run E2E tests
        working-directory: e2e-test
        run: npm test

      - name: Collect logs and diagnostics on failure
        if: failure()
        run: |
          echo "## ðŸ” Failure Diagnostics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ML0 Cluster Info" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          curl -sf http://localhost:9200/cluster/info 2>/dev/null | jq . >> $GITHUB_STEP_SUMMARY || echo "Failed to fetch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ML0 Latest Snapshot Ordinal" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          curl -sf http://localhost:9200/snapshots/latest 2>/dev/null | jq '{ordinal: (.value.ordinal // .ordinal), hash: (.value.hash // .hash)}' >> $GITHUB_STEP_SUMMARY || echo "Failed to fetch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### GL0 Cluster Info" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          curl -sf http://localhost:9000/cluster/info 2>/dev/null | jq . >> $GITHUB_STEP_SUMMARY || echo "Failed to fetch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### DL1-0 Cluster Info" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          curl -sf http://localhost:9400/cluster/info 2>/dev/null | jq . >> $GITHUB_STEP_SUMMARY || echo "Failed to fetch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Container Logs (last 50 lines)" >> $GITHUB_STEP_SUMMARY
          for container in gl0-0 ml0-0 dl1-0; do
            echo "#### $container" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            docker logs "$container" --tail 50 2>&1 >> $GITHUB_STEP_SUMMARY || echo "Container not found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - name: Cleanup
        if: always()
        working-directory: tessellation
        run: just down || docker compose down -v || true
