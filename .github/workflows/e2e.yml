name: E2E Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

env:
  TESSELLATION_VERSION: "4.0.0-rc.2"

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'sbt'

      - name: Set up sbt
        uses: sbt/setup-sbt@v1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Clone tessellation
        run: |
          git clone --depth 1 --branch "v${TESSELLATION_VERSION}" \
            https://github.com/Constellation-Labs/tessellation.git tessellation

      - name: Apply tessellation patches
        working-directory: tessellation
        run: |
          git apply ../e2e-test/patches/v4.0.0-rc.2-compile-fix.patch
          git apply ../e2e-test/patches/v4.0.0-rc.2-java21-deps.patch

      - name: Start cluster
        working-directory: tessellation
        run: |
          export TESSELLATION_VERSION="${TESSELLATION_VERSION}"
          just up --metagraph="${GITHUB_WORKSPACE}" --dl1 --data

      - name: Wait for cluster health
        run: |
          wait_for_node() {
            local name=$1 port=$2
            for i in $(seq 1 60); do
              if curl -sf "http://localhost:${port}/node/info" 2>/dev/null | grep -q '"state":"Ready"'; then
                echo "  $name (port $port): Ready"
                return 0
              fi
              sleep 2
            done
            echo "  $name (port $port): TIMEOUT" && return 1
          }
          
          echo "Waiting for nodes..."
          wait_for_node "GL0" 9000
          wait_for_node "ML0" 9200
          wait_for_node "DL1-0" 9400
          wait_for_node "DL1-1" 9410
          wait_for_node "DL1-2" 9420

      - name: Join DL1 validators to cluster
        run: |
          echo "=== Joining DL1 validators to cluster ==="
          
          # Get DL1-0 (genesis) peer ID for join payload
          DL1_PEER_ID=$(curl -s http://localhost:9400/node/info | jq -r '.id')
          # DL1-0 is on the tessellation_common network at 172.32.0.50
          DL1_IP="172.32.0.50"
          DL1_P2P_PORT="9401"
          
          echo "DL1 genesis peer: ${DL1_PEER_ID:0:32}..."
          echo "DL1 genesis IP: $DL1_IP"
          
          # Check current cluster size
          INITIAL_SIZE=$(curl -s http://localhost:9400/cluster/info | jq 'length' 2>/dev/null || echo "0")
          echo "Initial DL1 cluster size: $INITIAL_SIZE"
          
          if [ "$INITIAL_SIZE" -ge 3 ]; then
            echo "âœ“ DL1 cluster already has $INITIAL_SIZE peers, skipping manual join"
          else
            # Wait for DL1-1 and DL1-2 to reach ReadyToJoin state
            echo "Waiting for DL1 validators to reach ReadyToJoin state..."
            for port in 9410 9420; do
              for i in $(seq 1 30); do
                STATE=$(curl -s http://localhost:$port/node/state 2>/dev/null | tr -d '"' || echo "unknown")
                if [ "$STATE" = "ReadyToJoin" ] || [ "$STATE" = "Observing" ] || [ "$STATE" = "Ready" ]; then
                  echo "âœ“ DL1 (port $port) ready to join (state: $STATE)"
                  break
                fi
                if [ "$i" = "30" ]; then
                  echo "::warning::DL1 (port $port) did not reach ReadyToJoin state (current: $STATE)"
                fi
                sleep 2
              done
            done
            
            # Join DL1-1 and DL1-2 to cluster
            echo "Joining DL1 validators to cluster..."
            JOIN_PAYLOAD=$(printf '{"id":"%s","ip":"%s","p2pPort":%s}' "$DL1_PEER_ID" "$DL1_IP" "$DL1_P2P_PORT")
            echo "JOIN_PAYLOAD: $JOIN_PAYLOAD"
            
            for container in dl1-1 dl1-2; do
              echo "Joining $container..."
              if docker exec $container curl -sf -X POST http://localhost:9042/cluster/join \
                  -H 'Content-Type: application/json' \
                  -d "$JOIN_PAYLOAD"; then
                echo "âœ“ $container join initiated"
              else
                echo "::warning::$container join may have failed"
              fi
            done
            
            # Wait for cluster to stabilize
            echo "Waiting for DL1 cluster to stabilize..."
            sleep 10
          fi
          
          # Verify final cluster size
          FINAL_SIZE=$(curl -s http://localhost:9400/cluster/info | jq 'length' 2>/dev/null || echo "0")
          echo "Final DL1 cluster size: $FINAL_SIZE"
          
          if [ "$FINAL_SIZE" -lt 3 ]; then
            echo "::warning::DL1 cluster size is $FINAL_SIZE (expected 3)"
            curl -s http://localhost:9400/cluster/info | jq . || true
          else
            echo "âœ“ DL1 cluster has $FINAL_SIZE peers"
          fi

      - name: Verify ML0 ordinal progression
        run: |
          echo "Checking ML0 ordinal progression..."
          # Wait a bit for consensus to warm up after node startup
          sleep 10
          ORD1=$(curl -sf http://localhost:9200/snapshots/latest 2>/dev/null | jq -r '.value.ordinal // .ordinal // empty' || echo "")
          if [ -z "$ORD1" ]; then
            echo "::warning::Could not fetch initial ML0 ordinal â€” skipping progression check"
          else
            echo "  Initial ordinal: $ORD1"
            sleep 30
            ORD2=$(curl -sf http://localhost:9200/snapshots/latest 2>/dev/null | jq -r '.value.ordinal // .ordinal // empty' || echo "")
            echo "  After 30s: $ORD2"
            if [ "$ORD1" = "$ORD2" ]; then
              echo "::warning::Ordinals haven't advanced ($ORD1), retrying after 30s grace period..."
              sleep 30
              ORD3=$(curl -sf http://localhost:9200/snapshots/latest 2>/dev/null | jq -r '.value.ordinal // .ordinal // empty' || echo "")
              echo "  After 60s total: $ORD3"
              if [ "$ORD1" = "$ORD3" ]; then
                echo "::error::ML0 consensus stalled â€” ordinal stuck at $ORD1 for 60 seconds"
                echo "## âš ï¸ ML0 Consensus Stall Detected" >> $GITHUB_STEP_SUMMARY
                echo "Ordinal stuck at \`$ORD1\` for 60 seconds after warmup." >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### Cluster Info" >> $GITHUB_STEP_SUMMARY
                curl -sf http://localhost:9200/cluster/info 2>/dev/null | jq . >> $GITHUB_STEP_SUMMARY || true
                exit 1
              fi
              echo "  âœ“ Ordinals advancing after grace period ($ORD1 â†’ $ORD3)"
            else
              echo "  âœ“ Ordinals advancing ($ORD1 â†’ $ORD2)"
            fi
          fi

      - name: Install E2E dependencies
        working-directory: e2e-test
        run: npm ci

      - name: Pre-flight canary transaction
        working-directory: e2e-test
        continue-on-error: true
        run: npx tsx scripts/canary-check.ts --maxRetries 30 --retryDelay 5

      - name: Run E2E tests
        working-directory: e2e-test
        run: npm test

      - name: Collect logs and diagnostics on failure
        if: failure()
        run: |
          echo "## ðŸ” Failure Diagnostics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ML0 Cluster Info" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          curl -sf http://localhost:9200/cluster/info 2>/dev/null | jq . >> $GITHUB_STEP_SUMMARY || echo "Failed to fetch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ML0 Latest Snapshot Ordinal" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          curl -sf http://localhost:9200/snapshots/latest 2>/dev/null | jq '{ordinal: (.value.ordinal // .ordinal), hash: (.value.hash // .hash)}' >> $GITHUB_STEP_SUMMARY || echo "Failed to fetch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### GL0 Cluster Info" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          curl -sf http://localhost:9000/cluster/info 2>/dev/null | jq . >> $GITHUB_STEP_SUMMARY || echo "Failed to fetch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### DL1-0 Cluster Info" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          curl -sf http://localhost:9400/cluster/info 2>/dev/null | jq . >> $GITHUB_STEP_SUMMARY || echo "Failed to fetch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Container Logs (last 50 lines)" >> $GITHUB_STEP_SUMMARY
          for container in gl0-0 ml0-0 dl1-0; do
            echo "#### $container" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            docker logs "$container" --tail 50 2>&1 >> $GITHUB_STEP_SUMMARY || echo "Container not found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - name: Cleanup
        if: always()
        working-directory: tessellation
        run: just down || docker compose down -v || true
