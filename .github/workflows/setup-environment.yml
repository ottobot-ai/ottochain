name: Setup environment

on:
  workflow_call:
    inputs:
      tessellation_commit_hash:
        required: false
        description: "Specific tessellation commit hash to use. If not provided, latest develop commit will be used"
        type: string
      use_merge_commit:
        required: false
        type: boolean
        default: false
        description: "Whether to use the PR merge commit SHA instead of the head SHA"
    outputs:
      dep-cache-key:
        description: "Dependency cache key"
        value: ${{ jobs.setup-hypergraph.outputs.dep-cache-key }}

jobs:
  setup-hypergraph:
    name: Setup Hypergraph
    runs-on: ubuntu-22.04
    outputs:
      dep-cache-key: ${{ steps.set-cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate dependency cache key
        id: set-cache-key
        shell: bash
        run: |
          # Compute hash of all dependency-related files
          FILES_HASH=$(find . -type f \( -name "build.sbt" -o -name "*.sbt" -o -name "Dependencies.scala" -o -name "build.properties" -o -name "version.sbt" \) -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "key=dependency-${{ runner.os }}-${FILES_HASH}" >> $GITHUB_OUTPUT

      - name: Setup Java and scala
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          JAVA_VERSION: 11
        uses: "./.github/templates/actions/setup_java_and_scala"

      - name: Restore dependency cache
        uses: actions/cache@v4
        id: dep-cache
        with:
          path: |
            ~/.m2
            ~/.ivy2
            ~/.sbt
          key: ${{ steps.set-cache-key.outputs.key }}
          restore-keys: |
            dependency-${{ runner.os }}-

      - name: Setup Hypergraph
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TESSELLATION_COMMIT_HASH: ${{ inputs.tessellation_commit_hash }}
        uses: "./.github/templates/actions/hypergraph/setup"

      - name: Upload hypergraph artifacts to run CI tests
        uses: actions/upload-artifact@v4
        with:
          name: hypergraph
          path: .github/code/hypergraph
          retention-days: 7

      - name: Upload shared_jars artifacts to run CI tests
        uses: actions/upload-artifact@v4
        with:
          name: shared_jars
          path: .github/code/shared_jars
          retention-days: 7

  setup-metagraph:
    name: Setup Metagraph
    runs-on: ubuntu-22.04
    needs: setup-hypergraph
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ !inputs.use_merge_commit && github.event.pull_request.head.sha || '' }}

      - name: Setup Java and scala
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          JAVA_VERSION: 11
        uses: "./.github/templates/actions/setup_java_and_scala"

      - name: Restore dependency cache
        uses: actions/cache/restore@v4
        id: dep-cache
        with:
          path: |
            ~/.m2
            ~/.ivy2
            ~/.sbt
          key: ${{ needs.setup-hypergraph.outputs.dep-cache-key }}
          restore-keys: |
            dependency-${{ runner.os }}-

      - name: Download hypergraph artifacts
        uses: actions/download-artifact@v4
        with:
          name: hypergraph
          path: .github/code/hypergraph

      - name: Download shared_jars artifacts
        uses: actions/download-artifact@v4
        with:
          name: shared_jars
          path: .github/code/shared_jars

      - name: Log cache status
        shell: bash
        run: |
          if [ "${{ steps.dep-cache.outputs.cache-hit }}" == "true" ]; then
            echo "✅ Dependency cache successfully restored"
          else
            echo "⚠️ Failed to restore dependency cache, this may affect build performance"
          fi

      - name: Setup Metagraph
        with:
          METAGRAPH_NAME: workchain
          INCLUDE_DATA_LAYER: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CUSTOM_CONFIG: ${{ secrets.CUSTOM_CONFIG }}
        uses: "./.github/templates/actions/metagraph/setup"

      - name: Upload metagraph artifacts to run CI tests
        uses: actions/upload-artifact@v4
        with:
          name: workchain
          path: .github/code/metagraphs/workchain
          retention-days: 7
