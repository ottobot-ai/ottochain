openapi: 3.0.3
info:
  title: OttoChain Metagraph API
  description: |
    API for interacting with OttoChain metagraph on Constellation Network.
    
    ## Layers & Ports
    | Layer | Port | Description |
    |-------|------|-------------|
    | GL0   | 9000 | Global L0 — DAG consensus |
    | GL1   | 9100 | Global L1 — DAG transaction batching |
    | ML0   | 9200 | Metagraph L0 — OttoChain snapshots |
    | CL1   | 9300 | Currency L1 — token transactions |
    | DL1   | 9400 | Data L1 — data transaction validation |
  version: 1.0.0
  contact:
    name: OttoChain
    url: https://github.com/scasplte2/ottochain
  license:
    name: MIT

servers:
  - url: http://localhost:9200
    description: Local ML0 (Metagraph L0)
  - url: http://localhost:9400
    description: Local DL1 (Data L1)

tags:
  - name: Node
    description: Node status and health
  - name: Cluster
    description: Cluster management
  - name: Snapshots
    description: Metagraph snapshots
  - name: StateMachines
    description: OttoChain state machines (fibers)
  - name: Currency
    description: Token operations

paths:
  # ===== Node Endpoints =====
  /node/info:
    get:
      tags: [Node]
      summary: Get node information
      operationId: getNodeInfo
      responses:
        '200':
          description: Node information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeInfo'

  /node/state:
    get:
      tags: [Node]
      summary: Get node state
      operationId: getNodeState
      responses:
        '200':
          description: Current node state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeState'

  /node/health:
    get:
      tags: [Node]
      summary: Health check
      operationId: getHealth
      responses:
        '200':
          description: Node is healthy
        '503':
          description: Node is unhealthy

  # ===== Cluster Endpoints =====
  /cluster/info:
    get:
      tags: [Cluster]
      summary: Get cluster info
      operationId: getClusterInfo
      responses:
        '200':
          description: Cluster peer list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClusterPeer'

  /cluster/session:
    get:
      tags: [Cluster]
      summary: Get cluster session
      operationId: getClusterSession
      responses:
        '200':
          description: Current cluster session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClusterSession'

  # ===== Snapshot Endpoints (ML0) =====
  /snapshots/latest:
    get:
      tags: [Snapshots]
      summary: Get latest snapshot
      operationId: getLatestSnapshot
      responses:
        '200':
          description: Latest metagraph snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Snapshot'

  /snapshots/latest/ordinal:
    get:
      tags: [Snapshots]
      summary: Get latest ordinal
      operationId: getLatestOrdinal
      responses:
        '200':
          description: Latest snapshot ordinal
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotOrdinal'

  /snapshots/{ordinal}:
    get:
      tags: [Snapshots]
      summary: Get snapshot by ordinal
      operationId: getSnapshotByOrdinal
      parameters:
        - name: ordinal
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Snapshot at ordinal
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Snapshot'
        '404':
          description: Snapshot not found

  # ===== OttoChain Custom Endpoints =====
  /v1/state-machines:
    get:
      tags: [StateMachines]
      summary: List all state machines
      operationId: listStateMachines
      responses:
        '200':
          description: List of state machine fiber records
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StateMachineFiberRecord'

  /v1/state-machines/{fiberId}:
    get:
      tags: [StateMachines]
      summary: Get state machine by fiber ID
      operationId: getStateMachine
      parameters:
        - name: fiberId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: State machine fiber record
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StateMachineFiberRecord'
        '404':
          description: State machine not found

  /v1/checkpoint:
    get:
      tags: [StateMachines]
      summary: Get latest checkpoint
      operationId: getCheckpoint
      responses:
        '200':
          description: Latest on-chain state checkpoint
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OnChainState'

  # ===== Currency Endpoints =====
  /currency/{address}/balance:
    get:
      tags: [Currency]
      summary: Get token balance
      operationId: getBalance
      parameters:
        - name: address
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/Address'
      responses:
        '200':
          description: Token balance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Balance'

  /currency/total-supply:
    get:
      tags: [Currency]
      summary: Get total token supply
      operationId: getTotalSupply
      responses:
        '200':
          description: Total supply
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenSupply'

  # ===== Data L1 Endpoints =====
  /data:
    post:
      tags: [StateMachines]
      summary: Submit data transaction
      operationId: submitDataTransaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DataTransaction'
      responses:
        '200':
          description: Transaction accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionResponse'
        '400':
          description: Invalid transaction

components:
  schemas:
    # ===== Common Types (from ottochain.v1.common) =====
    Address:
      type: string
      pattern: '^DAG[0-9A-Za-z]{37}$'
      description: Constellation DAG address
      example: "DAG4o41NzhfX6DyYBTTXu6sJa6awm36abJpv89jB"

    HashValue:
      type: string
      pattern: '^[a-f0-9]{64}$'
      description: 256-bit hash value
      example: "a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd"

    SnapshotOrdinal:
      type: object
      properties:
        value:
          type: integer
          format: int64
      required: [value]

    FiberOrdinal:
      type: object
      properties:
        value:
          type: integer
          format: int64
      required: [value]

    StateId:
      type: object
      properties:
        value:
          type: string
      required: [value]

    # ===== Node Types =====
    NodeInfo:
      type: object
      properties:
        state:
          $ref: '#/components/schemas/NodeState'
        version:
          type: string
        host:
          type: string
        publicPort:
          type: integer
        p2pPort:
          type: integer
        id:
          type: string
          description: Node peer ID
        session:
          type: string

    NodeState:
      type: string
      enum:
        - Initial
        - ReadyToJoin
        - LoadingGenesis
        - GenesisReady
        - RollbackInProgress
        - RollbackDone
        - StartingSession
        - SessionStarted
        - WaitingForDownload
        - DownloadInProgress
        - Observing
        - WaitingForObserving
        - WaitingForReady
        - Ready
        - Leaving
        - Offline

    # ===== Cluster Types =====
    ClusterPeer:
      type: object
      properties:
        id:
          type: string
        ip:
          type: string
        publicPort:
          type: integer
        p2pPort:
          type: integer
        session:
          type: string
        state:
          $ref: '#/components/schemas/NodeState'

    ClusterSession:
      type: object
      properties:
        token:
          type: string

    # ===== Snapshot Types =====
    Snapshot:
      type: object
      properties:
        ordinal:
          $ref: '#/components/schemas/SnapshotOrdinal'
        hash:
          $ref: '#/components/schemas/HashValue'
        lastSnapshotHash:
          $ref: '#/components/schemas/HashValue'
        timestamp:
          type: string
          format: date-time
        blocks:
          type: array
          items:
            type: object
        tips:
          type: object

    # ===== OttoChain State Machine Types (from ottochain.v1.records) =====
    StateMachineFiberRecord:
      type: object
      description: On-chain state machine fiber record
      properties:
        fiberId:
          type: string
          description: Unique fiber identifier
        creationOrdinal:
          $ref: '#/components/schemas/SnapshotOrdinal'
        previousUpdateOrdinal:
          $ref: '#/components/schemas/SnapshotOrdinal'
        latestUpdateOrdinal:
          $ref: '#/components/schemas/SnapshotOrdinal'
        definition:
          $ref: '#/components/schemas/StateMachineDefinition'
        currentState:
          $ref: '#/components/schemas/StateId'
        stateData:
          type: object
          description: Current state data (JSON)
        stateDataHash:
          $ref: '#/components/schemas/HashValue'
        sequenceNumber:
          $ref: '#/components/schemas/FiberOrdinal'
        owners:
          type: array
          items:
            $ref: '#/components/schemas/Address'
        status:
          $ref: '#/components/schemas/FiberStatus'
        lastReceipt:
          $ref: '#/components/schemas/EventReceipt'
        parentFiberId:
          type: string
        childFiberIds:
          type: array
          items:
            type: string

    StateMachineDefinition:
      type: object
      description: State machine definition (from ottochain.v1.fiber)
      properties:
        states:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/StateDefinition'
        initialState:
          $ref: '#/components/schemas/StateId'
        version:
          type: string

    StateDefinition:
      type: object
      properties:
        transitions:
          type: array
          items:
            $ref: '#/components/schemas/TransitionDefinition'
        onEnter:
          type: object
        onExit:
          type: object

    TransitionDefinition:
      type: object
      properties:
        event:
          type: string
        target:
          $ref: '#/components/schemas/StateId'
        guard:
          type: object
          description: JSON Logic guard condition
        actions:
          type: array
          items:
            type: object

    FiberStatus:
      type: string
      enum:
        - FIBER_STATUS_UNSPECIFIED
        - ACTIVE
        - COMPLETED
        - SUSPENDED
        - DEACTIVATED
        - MIGRATING
        - PENDING_VERIFICATION
      description: Current fiber status

    EventReceipt:
      type: object
      properties:
        eventHash:
          $ref: '#/components/schemas/HashValue'
        success:
          type: boolean
        resultData:
          type: object
        errorMessage:
          type: string

    OnChainState:
      type: object
      description: Complete on-chain state checkpoint
      properties:
        fiberCommits:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/FiberCommit'
        latestLogs:
          type: object
          additionalProperties:
            type: array
            items:
              $ref: '#/components/schemas/FiberLogEntry'

    FiberCommit:
      type: object
      properties:
        recordHash:
          $ref: '#/components/schemas/HashValue'
        stateDataHash:
          $ref: '#/components/schemas/HashValue'
        sequenceNumber:
          $ref: '#/components/schemas/FiberOrdinal'

    FiberLogEntry:
      type: object
      properties:
        ordinal:
          $ref: '#/components/schemas/FiberOrdinal'
        eventType:
          type: string
        data:
          type: object
        timestamp:
          type: string
          format: date-time

    # ===== Currency Types =====
    Balance:
      type: object
      properties:
        balance:
          type: integer
          format: int64
        ordinal:
          $ref: '#/components/schemas/SnapshotOrdinal'

    TokenSupply:
      type: object
      properties:
        total:
          type: integer
          format: int64

    # ===== Transaction Types =====
    DataTransaction:
      type: object
      properties:
        value:
          type: object
          description: Transaction payload
        proofs:
          type: array
          items:
            $ref: '#/components/schemas/Proof'

    Proof:
      type: object
      properties:
        id:
          type: string
        signature:
          type: string

    TransactionResponse:
      type: object
      properties:
        hash:
          $ref: '#/components/schemas/HashValue'
