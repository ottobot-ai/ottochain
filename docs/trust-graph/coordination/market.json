{
  "metadata": {
    "name": "Market",
    "description": "Universal market state machine: predictions, auctions, crowdfunding, group buys",
    "version": "1.0.0"
  },
  "states": {
    "PROPOSED": { "id": { "value": "PROPOSED" }, "isFinal": false },
    "OPEN": { "id": { "value": "OPEN" }, "isFinal": false },
    "CLOSED": { "id": { "value": "CLOSED" }, "isFinal": false },
    "RESOLVING": { "id": { "value": "RESOLVING" }, "isFinal": false },
    "SETTLED": { "id": { "value": "SETTLED" }, "isFinal": true },
    "REFUNDED": { "id": { "value": "REFUNDED" }, "isFinal": true },
    "CANCELLED": { "id": { "value": "CANCELLED" }, "isFinal": true }
  },
  "initialState": { "value": "PROPOSED" },
  "transitions": [
    {
      "_comment": "Creator opens the market for participation",
      "from": { "value": "PROPOSED" },
      "to": { "value": "OPEN" },
      "eventName": "open",
      "guard": { "===": [{ "var": "event.agent" }, { "var": "state.creator" }] },
      "effect": {
        "merge": [
          { "var": "state" },
          { "status": "OPEN", "openedAt": { "var": "$timestamp" } }
        ]
      }
    },
    {
      "_comment": "Creator cancels before opening",
      "from": { "value": "PROPOSED" },
      "to": { "value": "CANCELLED" },
      "eventName": "cancel",
      "guard": { "===": [{ "var": "event.agent" }, { "var": "state.creator" }] },
      "effect": {
        "merge": [
          { "var": "state" },
          { "status": "CANCELLED", "cancelledAt": { "var": "$timestamp" }, "reason": { "var": "event.reason" } }
        ]
      }
    },
    {
      "_comment": "Participant commits resources (stake/bid/pledge/order)",
      "from": { "value": "OPEN" },
      "to": { "value": "OPEN" },
      "eventName": "commit",
      "guard": {
        "and": [
          { ">": [{ "var": "event.amount" }, 0] },
          { "or": [
            { "!": { "var": "state.deadline" } },
            { "<=": [{ "var": "$timestamp" }, { "var": "state.deadline" }] }
          ]}
        ]
      },
      "effect": {
        "merge": [
          { "var": "state" },
          {
            "commitments": {
              "setKey": [
                { "var": "state.commitments" },
                { "var": "event.agent" },
                {
                  "merge": [
                    { "getKey": [{ "var": "state.commitments" }, { "var": "event.agent" }, { "amount": 0, "data": {} }] },
                    {
                      "amount": { "+": [
                        { "getKey": [{ "getKey": [{ "var": "state.commitments" }, { "var": "event.agent" }, { "amount": 0 }] }, "amount", 0] },
                        { "var": "event.amount" }
                      ]},
                      "data": { "var": "event.data" },
                      "lastCommitAt": { "var": "$timestamp" }
                    }
                  ]
                }
              ]
            },
            "totalCommitted": { "+": [{ "var": "state.totalCommitted" }, { "var": "event.amount" }] }
          }
        ]
      }
    },
    {
      "_comment": "Close market for new commitments (manual or deadline)",
      "from": { "value": "OPEN" },
      "to": { "value": "CLOSED" },
      "eventName": "close",
      "guard": {
        "or": [
          { "===": [{ "var": "event.agent" }, { "var": "state.creator" }] },
          { "and": [
            { "var": "state.deadline" },
            { ">=": [{ "var": "$timestamp" }, { "var": "state.deadline" }] }
          ]}
        ]
      },
      "effect": {
        "merge": [
          { "var": "state" },
          { "status": "CLOSED", "closedAt": { "var": "$timestamp" } }
        ]
      }
    },
    {
      "_comment": "Submit resolution (oracle/auctioneer/system)",
      "from": { "value": "CLOSED" },
      "to": { "value": "RESOLVING" },
      "eventName": "submit_resolution",
      "guard": {
        "or": [
          { "in": [{ "var": "event.agent" }, { "var": "state.oracles" }] },
          { "===": [{ "var": "event.agent" }, { "var": "state.creator" }] }
        ]
      },
      "effect": {
        "merge": [
          { "var": "state" },
          {
            "status": "RESOLVING",
            "resolutions": {
              "cat": [
                { "var": "state.resolutions" },
                [{
                  "oracle": { "var": "event.agent" },
                  "outcome": { "var": "event.outcome" },
                  "proof": { "var": "event.proof" },
                  "submittedAt": { "var": "$timestamp" }
                }]
              ]
            }
          }
        ]
      }
    },
    {
      "_comment": "Additional oracle votes during resolution",
      "from": { "value": "RESOLVING" },
      "to": { "value": "RESOLVING" },
      "eventName": "submit_resolution",
      "guard": {
        "and": [
          { "in": [{ "var": "event.agent" }, { "var": "state.oracles" }] },
          { "!": { "in": [{ "var": "event.agent" }, { "map": [{ "var": "state.resolutions" }, { "var": "oracle" }] }] } }
        ]
      },
      "effect": {
        "merge": [
          { "var": "state" },
          {
            "resolutions": {
              "cat": [
                { "var": "state.resolutions" },
                [{
                  "oracle": { "var": "event.agent" },
                  "outcome": { "var": "event.outcome" },
                  "proof": { "var": "event.proof" },
                  "submittedAt": { "var": "$timestamp" }
                }]
              ]
            }
          }
        ]
      }
    },
    {
      "_comment": "Finalize when quorum reached or threshold met",
      "from": { "value": "RESOLVING" },
      "to": { "value": "SETTLED" },
      "eventName": "finalize",
      "guard": {
        "or": [
          { ">=": [{ "size": { "var": "state.resolutions" } }, { "var": "state.quorum" }] },
          { "===": [{ "var": "state.marketType" }, "crowdfund"] },
          { "===": [{ "var": "state.marketType" }, "group_buy"] },
          { "===": [{ "var": "state.marketType" }, "auction"] }
        ]
      },
      "effect": {
        "merge": [
          { "var": "state" },
          {
            "status": "SETTLED",
            "settledAt": { "var": "$timestamp" },
            "finalOutcome": { "var": "event.outcome" },
            "settlement": { "var": "event.settlement" }
          }
        ]
      }
    },
    {
      "_comment": "Refund if threshold not met",
      "from": { "value": "CLOSED" },
      "to": { "value": "REFUNDED" },
      "eventName": "refund",
      "guard": {
        "and": [
          { "var": "state.threshold" },
          { "<": [{ "var": "state.totalCommitted" }, { "var": "state.threshold" }] }
        ]
      },
      "effect": {
        "merge": [
          { "var": "state" },
          { "status": "REFUNDED", "refundedAt": { "var": "$timestamp" }, "reason": "threshold_not_met" }
        ]
      }
    },
    {
      "_comment": "Refund from resolving if disputed/failed",
      "from": { "value": "RESOLVING" },
      "to": { "value": "REFUNDED" },
      "eventName": "refund",
      "guard": {
        "or": [
          { "===": [{ "var": "event.agent" }, { "var": "state.creator" }] },
          { ">=": [{ "size": { "filter": [{ "var": "state.resolutions" }, { "===": [{ "var": "outcome" }, "INVALID"] }] } }, { "var": "state.quorum" }] }
        ]
      },
      "effect": {
        "merge": [
          { "var": "state" },
          { "status": "REFUNDED", "refundedAt": { "var": "$timestamp" }, "reason": { "var": "event.reason" } }
        ]
      }
    },
    {
      "_comment": "Claim winnings/rewards after settlement",
      "from": { "value": "SETTLED" },
      "to": { "value": "SETTLED" },
      "eventName": "claim",
      "guard": {
        "and": [
          { "getKey": [{ "var": "state.commitments" }, { "var": "event.agent" }] },
          { "!": { "getKey": [{ "var": "state.claims" }, { "var": "event.agent" }] } }
        ]
      },
      "effect": {
        "merge": [
          { "var": "state" },
          {
            "claims": {
              "setKey": [
                { "var": "state.claims" },
                { "var": "event.agent" },
                { "claimedAt": { "var": "$timestamp" }, "amount": { "var": "event.amount" } }
              ]
            }
          }
        ]
      }
    }
  ],
  "initialDataTemplate": {
    "_comment": "Template for creating new markets",
    "schema": "Market",
    "marketType": "prediction | auction | crowdfund | group_buy",
    "creator": "<address>",
    "title": "",
    "description": "",
    "terms": {
      "_comment": "Type-specific configuration",
      "prediction": { "question": "", "outcomes": ["YES", "NO"], "feePercent": 2 },
      "auction": { "item": "", "reservePrice": 0, "buyNowPrice": null },
      "crowdfund": { "goal": 0, "rewards": [], "allOrNothing": true },
      "group_buy": { "product": "", "unitPrice": 0, "bulkPrice": 0, "minUnits": 0 }
    },
    "deadline": null,
    "threshold": null,
    "oracles": [],
    "quorum": 1,
    "commitments": {},
    "totalCommitted": 0,
    "resolutions": [],
    "claims": {},
    "status": "PROPOSED"
  }
}
